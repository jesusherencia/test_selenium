package org.example;
// Generated by Selenium IDE

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.parallel.Execution;
import org.junit.jupiter.api.parallel.ExecutionMode;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.Platform;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.firefox.FirefoxDriver;
import org.openqa.selenium.firefox.FirefoxOptions;
import org.openqa.selenium.remote.AbstractDriverOptions;
import org.openqa.selenium.remote.DesiredCapabilities;
import org.openqa.selenium.remote.RemoteWebDriver;

import java.io.Closeable;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.List;
import java.util.Map;
import java.util.Properties;

@Execution(ExecutionMode.CONCURRENT)
//@RunWith(Parameterized.class)
public class TestSeleniumTest {
  private WebDriver driver;
  private Map<String, Object> vars;
  JavascriptExecutor js;

  private static final Properties confProperties = new Properties();
  static {
    InputStream input = TestSeleniumTest.class.getClassLoader().getResourceAsStream("conf.properties");
      try {
        TestSeleniumTest.confProperties.load(input);
      } catch (IOException e) {
          throw new RuntimeException(e);
      }
  }

  //String browserName;

  /*public TestGoogleTest(String browserName) {
    this.browserName = browserName;
  }*/

  /*@Parameterized.Parameters
  public static Collection<Object[]> primeNumbers() {
    return Arrays.asList(new Object[][] {
            { "chrome" },
            { "firefox" }
    });
  }*/

  @BeforeEach
  public void setUp() {
    //this.driver = createRemoteDriver("firefox");
    //this.driver = createLocalDriver("firefox");

    //js = (JavascriptExecutor) driver;
    //vars = new HashMap<String, Object>();
  }

  private WebDriver createDriver(String browserName) {
    String driverType = confProperties.getProperty("driver_type");
    if (driverType.equals("local")) {
      return createLocalDriver(browserName);
    } else if (driverType.equals("remote")) {
      return createRemoteDriver(browserName);
    }
    throw new RuntimeException("driver type is not valid: " + driverType);
  }

  private RemoteWebDriver createRemoteDriver(String browserName) {
    try {
      DesiredCapabilities dc = getDesiredCapabilities(Platform.LINUX, browserName);
      RemoteWebDriver driver = new RemoteWebDriver(new URL("http://127.0.0.1:4444"), dc);
      return driver;
    } catch (MalformedURLException e) {
      throw new RuntimeException(e);
    }
  }

  private WebDriver createLocalDriver(String browserName) {
    WebDriver driver = null;
    switch (browserName) {
      case "firefox": {
        FirefoxOptions options = new FirefoxOptions();
        setArgumentsInOptions(options, "firefox");
        driver = new FirefoxDriver(options);
        break;
      }
      case "chrome": {
        ChromeOptions options = new ChromeOptions();
        setArgumentsInOptions(options, "chrome");
        driver = new ChromeDriver(options);
        break;
      }
      case "MicrosoftEdge": {
        EdgeOptions options = new EdgeOptions();
        /*options.addArguments("--no-sandbox");
        String userDataDir = "--user-data-dir=" + System.getProperty("java.io.tmpdir") + "temp_profile";
        System.out.println(userDataDir);
        options.addArguments(userDataDir);*/
        setArgumentsInOptions(options, "MicrosoftEdge");
        driver = new EdgeDriver(options);
        break;
      }
    }
    return driver;
  }

  private static void setArgumentsInOptions(AbstractDriverOptions options, String browserName) {
    String os = System.getProperty("os.name").toLowerCase();
    boolean unixOS = os.contains("nux");
    if (unixOS) {
      // setting headless mode to true.. so there isn't any ui
      List<String> arguments = List.of("--headless", "--no-sandbox");
      switch (browserName) {
        case "firefox": {
          FirefoxOptions firefoxOptions = (FirefoxOptions) options;
          firefoxOptions.addArguments(arguments);
          break;
        }
        case "chrome": {
          ChromeOptions chromeOptions = (ChromeOptions) options;
          chromeOptions.addArguments(arguments);
          break;
        }
        case "MicrosoftEdge": {
          EdgeOptions edgeOptions = (EdgeOptions) options;
          edgeOptions.addArguments(arguments);
          break;
        }
        default:
          break;
      }
      //options.addArguments("--no-sandbox");
    }
  }

  private static DesiredCapabilities getDesiredCapabilities(Platform platform, String browserName) {
    DesiredCapabilities dc = new DesiredCapabilities();
    dc.setPlatform(platform);
    dc.setBrowserName(browserName);
    return dc;
  }

  @AfterEach
  public void tearDown() {
    //driver.quit();
  }

  //@Test
  @ParameterizedTest
  @ValueSource(strings = { "firefox", "chrome", "MicrosoftEdge" })
  public void testDuckDuckGo(String browserName) {
    WebDriver driver = createDriver(browserName);
    driver.get("https://duckduckgo.com/");
    driver.manage().window().maximize();
    driver.findElement(By.id("searchbox_input")).click();
    driver.findElement(By.id("searchbox_input")).sendKeys("abc");
    driver.findElement(By.cssSelector("button.iconButton_button__A_Uiu:nth-child(2)")).click();
    driver.quit();
  }

  //@Test
  @ParameterizedTest
  @ValueSource(strings = { "firefox", "chrome", "MicrosoftEdge" })
  public void testAbebooks(String browserName) throws IOException {
    try (var crd = new CloseableWebDriver(createDriver(browserName))) {
      WebDriver driver = crd.getDriver();
      //WebDriver driver = createRemoteDriver(browserName);
      driver.get("https://www.abebooks.fr/");
      driver.manage().window().maximize();
      driver.findElement(By.id("header-searchbox-input")).click();
      driver.findElement(By.id("header-searchbox-input")).sendKeys("abc");
      driver.findElement(By.id("header-searchbox-button")).click();
      //driver.quit();
    }
  }
}

class CloseableWebDriver implements Closeable {
  private final WebDriver driver;

  public CloseableWebDriver(WebDriver driver) {
    this.driver = driver;
  }

  public WebDriver getDriver() {
    return this.driver;
  }

  @Override
  public void close() throws IOException {
    this.driver.quit();
  }
}
